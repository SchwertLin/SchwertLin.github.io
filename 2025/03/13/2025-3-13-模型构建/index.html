<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="author" content="Schwertlilien"/><meta name="keyword"/><meta name="description" content="Zheng, Minghang, et al. “End-to-end object detection with adaptive clustering transformer.” arXiv preprint arXiv:2011.09315 (2020).  感觉这个图的形式差不多是我想画的样子。  然后来写我的模型——可恶就是不想写 首先，我不打算使用知识蒸馏。或许后续可以使用训练好的模">
<meta property="og:type" content="article">
<meta property="og:title" content="2025-3-13-模型构建">
<meta property="og:url" content="http://example.com/2025/03/13/2025-3-13-%E6%A8%A1%E5%9E%8B%E6%9E%84%E5%BB%BA/index.html">
<meta property="og:site_name" content="Schwertlilien">
<meta property="og:description" content="Zheng, Minghang, et al. “End-to-end object detection with adaptive clustering transformer.” arXiv preprint arXiv:2011.09315 (2020).  感觉这个图的形式差不多是我想画的样子。  然后来写我的模型——可恶就是不想写 首先，我不打算使用知识蒸馏。或许后续可以使用训练好的模">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/SchwertLin/Pic@main/img/image-20250313230520772.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/SchwertLin/Pic@main/img/image-20250314163117697.png">
<meta property="article:published_time" content="2025-03-13T11:43:22.000Z">
<meta property="article:modified_time" content="2025-04-11T03:07:42.000Z">
<meta property="article:author" content="Schwertlilien">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/SchwertLin/Pic@main/img/image-20250313230520772.png"><title>2025-3-13-模型构建 - Schwertlilien - -----personal blog-----</title><link rel="shortcut icon" href="/img/site-icon.png">
<link rel="stylesheet" href="/css/style.css" id="dm-light">


<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.2/css/all.min.css">

<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
<meta name="generator" content="Hexo 7.3.0"></head><body><header><div class="top-nav" ondblclick="scrollToTop()"><div class="nav-info"><div class="nav-icon"><img id="nav-icon" src="/img/site-icon.png"/></div><div class="nav-title"><a id="nav-title" href="/" title="主页">Schwertlilien</a></div></div><div class="nav-ribbon"><div class="top-menu-expanded"><a class="top-menu-item" href="/archives"><span>归档</span></a><a class="top-menu-item" href="/categories"><span>分类</span></a><a class="top-menu-item" href="/tags"><span>标签</span></a><a class="top-menu-item" href="/about"><span>关于</span></a></div><div class="top-search" onclick="toggleSearchWindow()"><div id="top-search-btn" title="搜索"><i class="icon fa-solid fa-magnifying-glass"></i><span>搜索</span></div></div><div id="top-menu-btn" onclick="openTopMenu()" title="打开菜单"><i class="fa-solid fa-bars fa-lg"></i></div></div></div></header><div id="top-menu-hidden"><div class="menu-hidden-content"><div class="menu-hidden-nav"><a class="menu-hidden-item" href="/archives"><i class="fa-solid fa-box-archive fa-sm"></i><span>归档</span></a><a class="menu-hidden-item" href="/categories"><i class="fa-regular fa-folder-open fa-sm"></i><span>分类</span></a><a class="menu-hidden-item" href="/tags"><i class="fa-solid fa-tags fa-sm"></i><span>标签</span></a><a class="menu-hidden-item" href="/about"><i class="fa-solid fa-paw fa-sm"></i><span>关于</span></a></div></div><div class="menu-hidden-blank" onclick="closeTopMenu()"></div></div>
<div class="blog-info"><div class="blog-pic"><img id="blog-pic" src="/img/site-icon.png"/></div><div class="blog-title"><i class="fa-solid fa-paw fa-2xs fa-rotate-by"></i><span>Schwertlilien</span><i class="fa-solid fa-paw fa-2xs fa-rotate-by"></i></div><div class="blog-desc">As a recoder: notes and ideas.</div></div><div class="main"><div class="main-content"><article class="post"><div class="post-title"><h1><i class="fa-solid fa-paw"></i>2025-3-13-模型构建</h1></div><div class="post-info"><div class="post-info-first-line"><div class="post-date"><i class="icon fa-regular fa-calendar-plus" title="发布日期"></i><time class="publish-time">2025-03-13</time><i class="icon fa-regular fa-calendar-check" title="更新日期"></i><time class="update-time">2025-04-11</time></div>

</div><div class="post-info-second-line"><div class="post-copyright"><i class="icon fa-brands fa-creative-commons" title="版权声明"></i><span>版权声明: </span><a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh-hans" title="CC BY-NC-ND 4.0">署名-非商业性使用-禁止演绎 4.0</a></div>
<div class="post-word-count"><i class="icon fa-solid fa-pen-to-square"></i><span>全文约1.5K字</span></div><div class="pageview-post"><i class="icon fa-regular fa-eye"></i><span id="busuanzi_container_page_pv">阅读次数: <span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner"></i></span></span></div></div></div><div class="post-content"><blockquote>
<p>Zheng, Minghang, et al. “End-to-end object detection with adaptive clustering transformer.” <em>arXiv preprint arXiv:2011.09315</em> (2020).</p>
</blockquote>
<p>感觉这个图的形式差不多是我想画的样子。</p>
<p><img src="https://cdn.jsdelivr.net/gh/SchwertLin/Pic@main/img/image-20250313230520772.png" alt="image-20250313230520772"></p>
<p>然后来写我的模型——可恶就是不想写</p>
<p>首先，我不打算使用知识蒸馏。或许后续可以使用训练好的模型再进行知识蒸馏。</p>
<p>输入是一系列的图片，然后将其划分为16*16的patch，然后+pos encoding</p>
<p>得到一系列的向量</p>
<p>投入transformer（DS修改版）*N</p>
<p>输出pred head</p>
<p>对于每层decoder输出的pred head,作为序列信息，用于强化学习。</p>
<p>将 DETR 的解码器每层视为 RL 的一步，定义状态为当前层的对象查询，动作为更新查询，奖励为当前预测与真实框的 IoU（交并比）或分类准确度。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>State</th>
<th>Action</th>
<th>Reward</th>
</tr>
</thead>
<tbody>
<tr>
<td>状态定义为当前层的对象查询。</td>
<td>动作是更新这些查询。</td>
<td>奖励基于预测与真实框的 IoU 或分类准确度。</td>
</tr>
<tr>
<td>每一层的状态是当前的对象查询，这些查询用于预测边界框和类别。</td>
<td>动作是解码器层对对象查询的更新。为了让 RL 工作，需要让更新有随机性，比如在更新时加入噪声。</td>
<td>奖励函数可定义为均值 IoU 加权分类准确度。</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>这种方法类似于添加辅助损失，可能与标准训练效果类似，但 RL 可提供更多探索性。</p>
</blockquote>
<p>梯度更新：</p>
<p><img src="https://cdn.jsdelivr.net/gh/SchwertLin/Pic@main/img/image-20250314163117697.png" alt="image-20250314163117697"></p>
<h3 id="状态定义"><a href="#状态定义" class="headerlink" title="状态定义"></a>状态定义</h3><ul>
<li>状态$s_k $ 定义为第 $ k$ 层输入的对象查询$q_k $。这些查询是解码器从上一层继承的，用于与编码器输出交互，生成预测。</li>
<li>在 RL 框架中，状态反映当前环境，对象查询的当前状态直接影响后续层的预测。</li>
</ul>
<h3 id="动作定义"><a href="#动作定义" class="headerlink" title="动作定义"></a>动作定义</h3><ul>
<li>动作 $a_k $是第$ k $层对对象查询的更新，即从$q_k $到$ q_{k+1}$ 的变换。在标准 DETR 中，这一更新是确定性的，由自注意力、交叉注意力和前馈网络决定。</li>
<li>为使 RL 工作，需引入随机性，使更新成为概率分布。例如，可以让层输出对象查询的均值和方差，从正态分布中采样$q_{k+1} $，概率为$p(q_{k+1} | q_k, \theta_k) $，其中$\theta_k $ 是层的参数。</li>
</ul>
<h3 id="奖励定义"><a href="#奖励定义" class="headerlink" title="奖励定义"></a>奖励定义</h3><ul>
<li>奖励 $r_k $基于第$ k$ 层输出 $q_{k+1} $后的预测质量。预测包括边界框和类别标签，与真实框比较。</li>
<li>计算方法：<ol>
<li>用 $q_{k+1}$ 生成预测边界框和类别。</li>
<li>用匈牙利算法匹配预测与真实框，计算均值IoU$\text{mean}(\text{IoU}_k)$和分类准确度（$\text{accuracy}_k$）。</li>
<li>奖励公式为：$ r_k = \text{mean}(\text{IoU}_k) + \alpha \times \text{accuracy}_k $，其中$\alpha$是权重因子，需实验确定（如 0.5）。</li>
</ol>
</li>
<li>替代方案：奖励可以是负损失，即$r_k = - (\text{box_loss}_k + \text{class_loss}_k)$ ，其中 $\text{box_loss}_k$ 和$\text{class_loss}_k$ 是基于当前预测的边界框回归损失和分类损失。</li>
</ul>
<h3 id="优化过程"><a href="#优化过程" class="headerlink" title="优化过程"></a>优化过程</h3><ul>
<li>目标是最大化所有层的累积奖励：$ J = \mathbb{E}\left[ \sum_{k=1}^N r_k \right]$ 。</li>
<li>使用 RL 算法如 REINFORCE，梯度更新公式为： $\nabla_{\theta_k} J \approx \sum \left( \sum_{m=k}^N r_m \right) \times \nabla_{\theta_k} \log p(q_{k+1} | q_k, \theta_k)$ 其中，内层和是所有样本，外层和是从第 k k k 层到最后层的奖励总和，反映每一层的贡献。</li>
<li>实际中，可用策略梯度方法（如 PPO）优化，考虑探索性和稳定性。</li>
</ul>
<p>实际应用示例</p>
<p>假设 DETR 解码器有 6 层（N=6 N = 6 N=6），训练过程如下：</p>
<ol>
<li>初始化对象查询，输入第一层。</li>
<li>每层输出更新后的对象查询，立即用当前查询预测边界框和类别。</li>
<li>计算当前预测的均值 IoU 和分类准确度，代入公式$ r_k = \text{mean}(\text{IoU}_k) + 0.5 \times \text{accuracy}_k$ 。</li>
<li>所有层的奖励累加，优化模型参数。</li>
<li>训练时，加入噪声使层输出随机，模拟 RL 的探索。</li>
</ol>
<p><strong>处理相似物体</strong>：增加惩罚项，奖励函数可为：</p>
<script type="math/tex; mode=display">
r_k = \text{mean\_IoU}_k + \alpha \times \text{accuracy}_k - \gamma \times \text{overlap\_penalty}</script><p>其中 overlap_penalty 是预测框之间 IoU 过高的惩罚，鼓励模型区分相近物体。</p>
<h4 id="如何将-A-i-应用于目标检测？"><a href="#如何将-A-i-应用于目标检测？" class="headerlink" title="如何将$A_i$应用于目标检测？"></a>如何将$A_i$应用于目标检测？</h4><p>$A_i$是优势函数，相当于序列打分函数。在目标检测中：</p>
<ul>
<li><strong>候选框和分类打分</strong>：对每层解码器生成的候选框和分类进行打分，打分基于奖励 $r_k$，如 IoU 和分类准确度。</li>
<li>如何成为序列信息：将 DETR 解码器看作序列过程，$o_1, o_2, \ldots, o_{t-1}, o_t, \ldots$代表每层的对象查询更新。每个 $o_t$是当前层的输出（候选框和分类），序列信息通过层间传递实现：<ul>
<li>状态$q_t$ 是第 $t$ 层对象查询，动作 $o_t$ 是更新到 $q_{t+1}$，概率为 $\pi_{\theta}(o_t|q_t)$。</li>
<li>优势 $A_i = r_i - b_i$，其中 $b_i$ 是基线（如批次平均奖励）。</li>
</ul>
</li>
</ul>
<p><strong>模型和符号定义</strong>：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>符号</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>$q$</td>
<td>输入状态，目标检测中为图像特征或对象查询。</td>
</tr>
<tr>
<td>$\pi_{\theta}(o</td>
<td>q)$</td>
<td>策略分布，模型输出动作 $o$ 的概率，$o$ 为对象查询更新。</td>
</tr>
<tr>
<td>$\pi_{\theta_{old}}(o</td>
<td>q)$</td>
<td>上一轮策略分布，用于比率计算。</td>
</tr>
<tr>
<td>$o_i$</td>
<td>第 i 个样本的动作，目标检测中为第 t 层的对象查询更新。</td>
</tr>
<tr>
<td>$G$</td>
<td>样本组大小，通常为批次大小。</td>
</tr>
<tr>
<td>$A_i$</td>
<td>优势函数，基于奖励$r_i$ 和基线 $b_i$，$A_i = (r_i - b_i)/std(r_i)$。</td>
</tr>
<tr>
<td>$\epsilon$</td>
<td>裁剪参数，控制策略更新范围，通常为 0.2。</td>
</tr>
<tr>
<td>$\pi_{ref}$</td>
<td>参考策略，用户指定为 ground truth（标注的 label 信息），目标检测中为真实框和类别分布。</td>
</tr>
<tr>
<td>$\beta$</td>
<td>KL 散度的权重，控制分类损失强度。</td>
</tr>
</tbody>
</table>
</div>
</div><div class="post-end"><div class="post-prev"><a href="/2025/03/13/2025-3-13-%E5%AE%9E%E9%AA%8C%E8%BF%9B%E5%B1%95/" title="上一篇文章"><i class="fa-solid fa-chevron-left fa-lg"></i></a></div><div class="post-next"><a href="/2025/03/13/2025-3-10-%E4%B8%8D%E6%89%93%E7%AE%97%E4%BD%BF%E7%94%A8KD/" title="下一篇文章"><i class="fa-solid fa-chevron-right fa-lg"></i></a></div></div></article><div class="comment" id="comment"><script src="https://giscus.app/client.js" data-repo="SchwertLin/SwertLin_Blog_Comment" data-repo-id="R_kgDONXjrCQ" data-category="Announcements" data-category-id="DIC_kwDONXjrCc4Cky9X" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="zh-CN" crossorigin="anonymous" async="async"></script></div><div id="post-toc"><aside class="toc-aside"><div class="toc-title"><span><i class="fa-solid fa-paw"></i>目录</span></div><div class="toc-container" id="toc-body"><ol class="toc-content"><li class="toc-content-item toc-content-level-3"><a class="toc-content-link" href="#%E7%8A%B6%E6%80%81%E5%AE%9A%E4%B9%89"><span class="toc-content-number">1.</span> <span class="toc-content-text">状态定义</span></a></li><li class="toc-content-item toc-content-level-3"><a class="toc-content-link" href="#%E5%8A%A8%E4%BD%9C%E5%AE%9A%E4%B9%89"><span class="toc-content-number">2.</span> <span class="toc-content-text">动作定义</span></a></li><li class="toc-content-item toc-content-level-3"><a class="toc-content-link" href="#%E5%A5%96%E5%8A%B1%E5%AE%9A%E4%B9%89"><span class="toc-content-number">3.</span> <span class="toc-content-text">奖励定义</span></a></li><li class="toc-content-item toc-content-level-3"><a class="toc-content-link" href="#%E4%BC%98%E5%8C%96%E8%BF%87%E7%A8%8B"><span class="toc-content-number">4.</span> <span class="toc-content-text">优化过程</span></a><ol class="toc-content-child"><li class="toc-content-item toc-content-level-4"><a class="toc-content-link" href="#%E5%A6%82%E4%BD%95%E5%B0%86-A-i-%E5%BA%94%E7%94%A8%E4%BA%8E%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%EF%BC%9F"><span class="toc-content-number">4.1.</span> <span class="toc-content-text">如何将$A_i$应用于目标检测？</span></a></li></ol></li></ol></div></aside><div class="toc-blank" onclick="tocToggle()"></div></div><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  }
});
MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for(i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.8/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async="async"></script></div></div><div id="tool-bar"><div id="tool-bar-main"><div id="tool-toggle" onclick="toolToggle()" title="设置"><i class="fa-solid fa-gear"></i></div><div id="toc-toggle" onclick="tocToggle()" title="目录"><i class="fa-solid fa-list-ul"></i></div><div id="go-to-comment" onclick="gotoComment()" title="评论"><i class="fa-regular fa-message fa-flip-horizontal"></i></div><div id="back-to-top" onclick="scrollToTop()" title="返回顶部"><i class="fa-solid fa-chevron-up"></i></div></div><div id="tool-bar-more" style="display: none;"><div id="darkmode-switch" onclick="darkmodeSwitch()" title="深色模式"><i class="fa-solid fa-circle-half-stroke"></i></div><div id="font-size-increase" onclick="fontSizeIncrease()" title="放大字体"><i class="fa-solid fa-plus"></i></div><div id="font-size-decrease" onclick="fontSizeDecrease()" title="缩小字体"><i class="fa-solid fa-minus"></i></div></div></div><div id="search-panel"><div class="search-container"><div class="search-head"><div class="search-title"><span><i class="fa-solid fa-paw"></i>搜索</span></div><div class="search-close-btn" onclick="toggleSearchWindow()"><i class="fa-regular fa-circle-xmark"></i></div></div><div class="search-box"><i class="fa-solid fa-magnifying-glass"></i><input id="search-input" type="text" placeholder="请输入需要搜索的内容……" value=""/></div><div class="search-body"><div id="search-count">匹配结果数: </div><div id="search-result"></div><div id="search-result-empty">未搜索到匹配的文章。</div></div></div></div><footer><div class="footer-content"><div class="copyright-info"><i class="fa-regular fa-copyright fa-xs"></i><span>2022 - 2025 </span><a href="/about">Schwertlilien</a><i class="fa-solid fa-cat fa-sm"></i><span>Powered by </span><a href="https://hexo.io/" target="_blank">Hexo</a><span> &amp; </span><a href="https://github.com/chanwj/hexo-theme-meow" target="_blank" title="v2.1.0">Theme Meow</a></div><div class="pageview-site"><span id="busuanzi_container_site_pv">总访问量 : <span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner"></i></span></span><span id="busuanzi_container_site_uv">总访客数 : <span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner"></i></span></span></div></div></footer>
<script>const GLOBAL_CONFIG = {
  comment: { theme: 'preferred_color_scheme'}
}
</script>
<script src="/js/third-party/darkmode.js"></script>
<script>var options = {
  dark: '/css/darkmode.css',
  startAt: '24:00',
  endAt: '06:00',
  checkSystemScheme: 'false',
  saveOnToggle: 'true'
};
var darkMode = new DarkMode(options);
// change comment theme synchronously 同步修改评论区主题
if (darkMode.getMode() == "dark" && (true || true)) {
  if (document.getElementById('comment')) {
    document.getElementById('comment').getElementsByTagName('script')[0].setAttribute('data-theme', 'noborder_dark');
  }
}
</script><script>if (localStorage.getItem('font-size')) {
  document.querySelector('.post-content').style.fontSize = localStorage.getItem('font-size') + 'px';
}
</script>
<script src="/js/theme/tool-bar.js"></script>


<script src="/js/theme/menu.js"></script>


<script src="/js/third-party/clipboard.min.js"></script>


<script src="/js/theme/copy.js"></script>
<script>copyCode();
</script>
<script src="/js/jquery-3.7.1.min.js"></script>


<script src="/js/theme/search.js"></script>
<script>searchFunc('/search.xml', 'search-input', 'search-result');
</script></body></html>